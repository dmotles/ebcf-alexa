# vim: ft=yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: >
  This is used to deploy/update the lambda function. It's called by the code pipeline.
Parameters:
    LambdaS3Bucket:
        Type: String
    LambdaS3Key:
        Type: String
Resources:
    LAMBDA:
        Type: 'AWS::Lambda::Function'
        Properties:
            Code:
                S3Bucket: !Ref LambdaS3Bucket
                S3Key: !Ref LambdaS3Key
            Role: !GetAtt [ExecutionRole, Arn]
            Handler: ebcf_alexa.lambda_handler
            Description: 'Elliott Bay Crossfit Alexa Skill'
            MemorySize: 128 #MB
            Timeout: 60 # secs
            Runtime: 'python3.6'

    AlexaInvokePermission:
      Type: 'AWS::Lambda::Permission'
      Properties:
        Action: 'lambda:InvokeFunction'
        Principal: 'alexa-appkit.amazon.com'
        FunctionName: !GetAtt [LAMBDA, Arn]

    ExecutionRole:
        Type: 'AWS::IAM::Role'
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: 'lambda.amazonaws.com'
                      Action: 'sts:AssumeRole'
            Path: /
            Policies:
              - PolicyName: logging
                PolicyDocument:
                  Version: 2012-10-17
                  Statement:
                    - Effect: Allow
                      Action:
                        - 'logs:CreateLogGroup'
                        - 'logs:CreateLogStream'
                        - 'logs:PutLogEvents'
                      Resource: '*'
